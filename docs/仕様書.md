# TalkArt システム仕様書

## 1. プロジェクト概要

### 1.1 基本情報
- **プロジェクト名**: TalkArt (トークアート)
- **バージョン**: 0.1.0
- **ベースシステム**: AITuberKit (Fork)
- **開発者**: @oboroge0
- **ライセンス**: 非商用利用は自由、商用利用はAITuberKitの商用ライセンスが必要

### 1.2 システムの目的
VTuberキャラクターとの対話を通じて、ユーザーの夏祭りの思い出を美しいAIアートワークに変換するインタラクティブな体験型システム。

### 1.3 動作モード
- **TalkArtモード**: 夏祭り思い出アート生成システム（デフォルト）
- **AITuberKitモード**: 通常のAITuberとしての対話機能

## 2. 技術仕様

### 2.1 フロントエンド技術スタック
```
- Framework: Next.js 14.2.5
- React: 18.3.1
- TypeScript: 5.0.2 (strict mode)
- Styling: Tailwind CSS 3.4.14
- State Management: Zustand 4.5.4
- Animation: CSS Transitions, React Spring
- Canvas Library: Konva.js 9.3.18
- Drawing Library: tldraw 3.15.0
```

### 2.2 AI/ML技術
```
- 画像生成: OpenAI DALL-E 3
- 音声合成: 13種類のTTSエンジン対応
  - OpenAI TTS
  - Google Text-to-Speech
  - VOICEVOX
  - Azure OpenAI TTS
  - その他10種類
- LLMプロバイダー: 
  - OpenAI
  - Anthropic
  - Google
  - Azure
  - その他多数対応
```

### 2.3 バックエンド技術
```
- API Routes: Next.js API Routes
- Database: Supabase (PostgreSQL)
- Storage: Supabase Storage
- Real-time: Supabase Realtime
- Authentication: Supabase Auth (オプション)
```

### 2.4 開発環境要件
```
- Node.js: ^20.0.0 (要求)
- npm: ^10.0.0
- TypeScript: 5.0.2
```

## 3. システムアーキテクチャ

### 3.1 ディレクトリ構造
```
TalkArt/
├── src/
│   ├── components/         # UIコンポーネント
│   │   ├── talkArt*.tsx   # TalkArt専用コンポーネント
│   │   ├── vrmViewer.tsx  # 3Dモデルビューア
│   │   └── live2DViewer.tsx # 2Dモデルビューア
│   ├── features/           # ビジネスロジック
│   │   ├── chat/          # AI対話システム
│   │   ├── messages/      # メッセージ処理
│   │   ├── stores/        # Zustand状態管理
│   │   └── talkart/       # TalkArt固有機能
│   ├── pages/             # ページコンポーネント
│   │   ├── api/           # APIエンドポイント
│   │   ├── index.tsx      # ホームページ
│   │   ├── talkart.tsx    # TalkArtメインページ
│   │   └── gallery.tsx    # ギャラリーページ
│   └── lib/               # ユーティリティ
├── public/                # 静的ファイル
├── locales/              # 多言語対応ファイル
└── scripts/              # ビルドスクリプト
```

### 3.2 主要コンポーネント構成

#### TalkArt専用コンポーネント
```
- talkArtForm: 質問応答フォーム
- talkArtResult: 結果表示
- talkArtGallery: ギャラリー表示
- talkArtGalleryBoard: 掲示板スタイルギャラリー
- talkArtGalleryCanvas: Canvasモード実装
- talkArtGalleryTldraw: tldrawモード実装
- talkArtFlyingAnimation: 飛行アニメーション
- talkArtAudioControl: 音声制御
- talkArtQuestionDisplay: 質問表示
- talkArtSessionStats: セッション統計
- talkArtParticles: パーティクル効果
```

## 4. データベース仕様

### 4.1 テーブル構造

#### talkart_artworks テーブル
```sql
CREATE TABLE talkart_artworks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id TEXT NOT NULL,
  image_url TEXT NOT NULL,
  prompt TEXT NOT NULL,
  responses JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  share_code TEXT UNIQUE,
  view_count INTEGER DEFAULT 0
);
```

#### インデックス
- idx_talkart_artworks_session_id
- idx_talkart_artworks_created_at
- idx_talkart_artworks_share_code

#### RLS（Row Level Security）ポリシー
- 読み取り: 全員許可
- 挿入: 全員許可
- 更新: view_countのみ全員許可

### 4.2 ストレージ構造
```
talkart-artworks/ (Supabase Storage Bucket)
├── {session_id}_{timestamp}.png  # 生成画像
└── thumbnails/                    # サムネイル（オプション）
```

## 5. API仕様

### 5.1 TalkArt API エンドポイント

#### POST /api/talkart/generate
**用途**: アートワーク生成
```typescript
Request:
{
  prompt: string;        // 生成プロンプト
  style?: string;        // アートスタイル
  sessionId: string;     // セッションID
}

Response:
{
  imageUrl: string;      // 生成画像URL
  prompt: string;        // 使用プロンプト
  metadata: {
    createdAt: string;
    sessionId: string;
    generationTime: number;
    style: string;
    demo?: boolean;
  }
}
```

#### GET /api/talkart/artwork/[code]
**用途**: 共有コードによるアートワーク取得
```typescript
Response:
{
  id: string;
  imageUrl: string;
  prompt: string;
  responses: Array<{
    question: string;
    selectedAnswer: string;
  }>;
  createdAt: string;
  viewCount: number;
}
```

#### POST /api/talkart/share/[id]
**用途**: アートワーク共有
```typescript
Response:
{
  shareCode: string;
  shareUrl: string;
}
```

#### GET /api/talkart/proxy-image
**用途**: CORS対応画像プロキシ
```typescript
Query Parameters:
- url: string (画像URL)

Response: 画像バイナリデータ
```

### 5.2 AITuberKit API（継承）

#### チャット関連
- POST /api/messages
- POST /api/ai/vercel
- POST /api/ai/custom
- POST /api/difyChat

#### 音声合成関連
- POST /api/openAITTS
- POST /api/tts-google
- POST /api/tts-voicevox
- POST /api/elevenLabs
- その他10種類のTTSエンドポイント

#### モデル管理
- GET /api/get-vrm-list
- GET /api/get-live2d-list
- POST /api/upload-vrm-list

## 6. ユーザー体験フロー

### 6.1 TalkArt体験フロー
```
1. スタート画面
   ↓
2. 質問フェーズ（3問）
   - 夏祭りの思い出について
   - 心に残った瞬間
   - その時の感情
   ↓
3. アート生成フェーズ
   - DALL-E 3による画像生成
   - ローディングアニメーション
   ↓
4. 結果表示
   - 生成アートの表示
   - ダウンロード/シェア機能
   ↓
5. ギャラリー
   - 作品の掲示板表示
   - フィルター機能
```

### 6.2 ギャラリーモード

#### Canvasモード（デフォルト）
- Konva.jsベースの実装
- ドラッグ＆ドロップ対応
- 削除機能
- 自由配置

#### tldrawモード（オプション）
- tldrawライブラリ使用
- 高度な描画機能
- 環境変数で切り替え可能

## 7. 設定仕様

### 7.1 環境変数

#### 必須設定
```env
# OpenAI API（DALL-E 3用）
OPENAI_API_KEY=your-api-key

# Supabase設定
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key

# TalkArtモード
NEXT_PUBLIC_TALKART_MODE=true
```

#### オプション設定
```env
# ギャラリーモード
NEXT_PUBLIC_USE_TLDRAW_GALLERY=false  # tldrawモード使用

# 背景画像
NEXT_PUBLIC_BACKGROUND_IMAGE_PATH=/images/summer-festival-bg.jpg

# 言語設定
NEXT_PUBLIC_SELECT_LANGUAGE=ja

# UI表示設定
NEXT_PUBLIC_SHOW_ASSISTANT_TEXT=true
NEXT_PUBLIC_SHOW_CHARACTER_NAME=true
NEXT_PUBLIC_SHOW_CONTROL_PANEL=true
```

### 7.2 設定ファイル (talkart.config.js)
```javascript
{
  experience: {
    duration: 90,        // 体験時間（秒）
    phases: {
      start: 5,
      questions: 45,
      generation: 10,
      result: 30
    }
  },
  questions: [...],      // 質問配列
  artGeneration: {
    style: 'summer_festival_watercolor',
    themes: ['japanese', 'festival', 'nostalgic', 'warm'],
    timeout: 10000
  },
  animations: {
    fadeInDuration: 300,
    fadeOutDuration: 300,
    buttonHoverScale: 1.05
  },
  audio: {
    completionSound: '/sounds/completion.mp3'
  },
  gallery: {
    maxDisplayCount: 50,
    gridColumns: 5
  }
}
```

## 8. セキュリティ仕様

### 8.1 APIキー管理
- 環境変数でのキー管理
- .envファイルのGit除外
- Vercelでの環境変数設定

### 8.2 CORS設定
- 画像プロキシAPIでCORS対応
- Supabase RLSによるアクセス制御

### 8.3 入力検証
- APIエンドポイントでの入力検証
- SQLインジェクション対策（Supabase利用）
- XSS対策（React自動エスケープ）

## 9. パフォーマンス最適化

### 9.1 画像最適化
- Next.js Image最適化（推奨）
- 遅延読み込み
- WebP/AVIF形式サポート

### 9.2 コード分割
- 動的インポート使用
- ページ単位での分割
- コンポーネントレベル分割

### 9.3 キャッシュ戦略
- 静的アセットのCDNキャッシュ
- APIレスポンスキャッシュ
- Supabaseクエリキャッシュ

## 10. デプロイメント

### 10.1 対応プラットフォーム
- **Vercel**（推奨）
- その他のNode.js対応ホスティング

### 10.2 ビルドコマンド
```bash
npm run build       # 本番ビルド
npm run start       # 本番サーバー起動
npm run dev         # 開発サーバー
npm run desktop     # Electronアプリ起動
```

### 10.3 CI/CD設定
- Git push時の自動デプロイ（Vercel）
- Pre-commitフック（Husky）
  - ESLint自動修正
  - TypeScriptビルドチェック

## 11. 既知の問題

### 11.1 ビルドエラー
- tldrawコンポーネントのインポートエラー
  - `TLUiMenuGroup` → `TldrawUiMenuGroup` への変更が必要

### 11.2 警告
- React Hooks依存関係警告: 18件
- 画像最適化警告: 7件（`<img>` → `<Image>`推奨）

### 11.3 環境の不整合
- Node.js v23.7.0使用中（要求: v20.x）
- npm v11.3.0使用中（要求: v10.x）

## 12. 今後の開発予定

### 12.1 機能追加
- [ ] ユーザー認証機能
- [ ] プライベートギャラリー
- [ ] SNS共有機能の拡張
- [ ] 多言語対応の強化

### 12.2 改善項目
- [ ] パフォーマンス最適化
- [ ] アクセシビリティ向上
- [ ] モバイル対応の改善
- [ ] テストカバレッジの向上

## 13. ライセンスと著作権

### 13.1 ライセンス
- 基本: AITuberKitのライセンスに準拠
- 非商用: 自由使用可能
- 商用: AITuberKit商用ライセンス必要

### 13.2 使用ライブラリ
- AITuberKit (ベースシステム)
- その他のOSSライブラリ（package.json参照）

### 13.3 クレジット
- 開発: @oboroge0
- ベースシステム: AITuberKit by @tegnike

---

**最終更新日**: 2025-08-13
**バージョン**: 1.0.0